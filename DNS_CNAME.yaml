- name: DNS CNAME Change
  hosts: "{{sourceserver}}"
  tasks:    
      
  - name: Retrieve CNAME from Fileserver
    ansible.windows.win_reg_stat:
      path: HKLM:\SOFTWARE\GAM\Ansible
      name: FS_CNAME
    register: FS_CNAME
    
- hosts: Domain_Controllers
  gather_facts: no
  tasks:  
    
  - name: Update CNAME record 
    community.windows.win_dns_record:
      name: FS_CNAME
      state: present
      type: "CNAME"
      value: "{{sourceserver}}"
      zone: "global.gam.com"
 
 
  - name: Update SPN 
    {{ "{{sourceserver}} | regex_replace('.global.gam.com') }}"
    win_command: "SETSPN -a host/FS_CNAME {{sourceserver}}"
